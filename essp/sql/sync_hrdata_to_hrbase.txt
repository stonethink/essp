create or replace trigger SYNC_HRDATA_TO_HRBASE
  before insert or update on essp_hr_employee_main_t  
  for each row
  --ESSP中的HR模K新加入的人T信息YD到HrBase系y的|l器
declare

  p_unitCode varchar2(50);
  p_rmId varchar2(50);
  p_rmName varchar2(200);
  p_attribute varchar2(100);
  p_operation varchar2(20);
  p_effectiveDate date;
  p_site varchar2(20);
  p_leaveDate date;
  p_baseRid number;
  p_isDirect char(1);
  x number;
  y number;
  p_attribute_group_rid number;
  p_hr_attribute varchar2(100);
  
begin
   p_site := 'WH';--各site不同O定
   --查新增或被修改的人T的部T理作榻YD后的Y源理
   --查等和工作型信息
   select u.unit_code,u.mg_id,u.mg_name
   into p_unitCode,p_rmId,p_rmName
   from essp_upms_unit u
   where u.unit_id = :NEW.dept;
   --查HR人T傩
   select c.name_english into p_hr_attribute from essp_hr_code_t c
   where c.kind_code='JOBTYP' and trim(c.code)=trim(:NEW.types);
   --如果操作⒔o人TO置殡x
   --t㈦x日期YD
   if :NEW.dimission_flag='1' then
      p_leaveDate:=:NEW.outdate;
   else
      p_leaveDate:=null;
   end if;
   --如果有a能tO置橹苯尤肆Γ否tO置殚g接人力
   if :NEW.productivity='0' then
      p_isDirect:='I';
   else 
      p_isDirect:='D';
   end if;
   --查HR傩员淼RID和的人T傩
   select count(*) into y from HRB_ATTRIBUTE_GROUP@DEV248LINK g,
   HRB_ATTRIBUTE@DEV248LINK a
   where g.attribute_rid=a.rid 
   and g.code=p_hr_attribute 
   and lower(g.site)=lower(p_site);
   if(y > 0) then
    select g.rid,a.code into p_attribute_group_rid,p_attribute
    from HRB_ATTRIBUTE_GROUP@DEV248LINK g,HRB_ATTRIBUTE@DEV248LINK a
    where g.attribute_rid=a.rid 
    and g.code=p_hr_attribute 
    and lower(g.site)=lower(p_site);
   end if;
   
--根不同的觳僮髟O置操作型字段值以及生效日期字段值
if INSERTING then 
      p_operation:='Insert';
      p_effectiveDate:=:NEW.indate;
elsif UPDATING then
      p_operation:='Update';
      p_effectiveDate:=:NEW.indate;
      --查HrBase人T主n中是否存在相同T工工的
      --如果有tridYD到Log表中的base_rid字段
      select count(*) into x from HRB_HUMAN_BASE@DEV248LINK
      where employee_id=:OLD.emp_code;
      
      if(x > 0) then
      select rid into p_baseRid from HRB_HUMAN_BASE@DEV248LINK
      where employee_id=:OLD.emp_code;
      end if;
end if;
   --浜玫YD到HrBase系y
   insert into HRB_HUMAN_BASE_LOG@DEV248LINK(base_rid, employee_id, unit_code, english_name,
   chinese_name, res_manager_id, res_manager_name, email, site, in_date,
   out_date, operation, effective_date, status, attribute, rst, rct, rut, attribute_group_rid, is_direct) 
   values(p_baseRid, :NEW.emp_code, p_unitCode, :NEW.name, :NEW.chinese_name,
   p_rmId, p_rmName, :NEW.e_mail, p_site, :NEW.indate, p_leaveDate, p_operation, 
   p_effectiveDate, 'Pending', p_attribute, 'N', sysdate, sysdate, p_attribute_group_rid, p_isDirect);

end SYNC_HRDATA_TO_HRBASE;
